# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン |
|------|-----------|
| Node.js | v24.13.0 |
| TypeScript | 5.x |
| npm | 11.x |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Vue.js | 3.x (Composition API) | フロントエンドUI | initial-requirementsで指定。SPA構築に適した軽量フレームワーク |
| Vite | 6.x | フロントエンドビルド | Vue.js公式推奨。高速なHMRで開発効率が高い |
| Hono | 4.x | バックエンドAPIサーバー | 軽量・高速なWebフレームワーク。TypeScriptファーストでNode.js対応 |
| Replicate SDK | latest | Replicate API クライアント | qwen3-tts呼び出しの公式SDK |
| @hono/node-server | latest | Node.jsアダプター | HonoをNode.jsで動作させるためのアダプター |
| uuid | 11.x | UUID生成 | ファイル名・エンティティIDの一意性確保 |
| fluent-ffmpeg | 2.x | ffmpegラッパー | Node.jsからffmpegを扱うための標準ライブラリ |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Vitest | 3.x | ユニットテスト | Viteネイティブで高速。TypeScript対応が標準 |
| Playwright | 1.x | E2Eテスト | initial-requirementsで指定。クロスブラウザ対応 |
| ESLint | 9.x | 静的解析 | コード品質の一貫性確保 |
| Prettier | 3.x | コードフォーマット | フォーマットの統一 |

### 外部依存

| 技術 | 用途 | 備考 |
|------|------|------|
| ffmpeg | BGM合成・mp3変換 | システムにインストール済みであること |
| Replicate API | qwen3-tts によるTTS | APIキーが必要（環境変数で管理） |

## アーキテクチャパターン

### クライアント・サーバーアーキテクチャ（レイヤード構成）

```
┌─────────────────────────────────────────┐
│   フロントエンド（Vue.js SPA）            │ ← UI・ユーザー操作
├─────────────────────────────────────────┤
│   バックエンドAPI（Hono）                  │
│  ┌───────────────────────────────────┐  │
│  │ コントローラー層                     │  │ ← リクエスト受付・バリデーション
│  ├───────────────────────────────────┤  │
│  │ サービス層                          │  │ ← ビジネスロジック（TTS・BGM合成）
│  ├───────────────────────────────────┤  │
│  │ データ層（リポジトリ）               │  │ ← ファイルシステムへの永続化
│  └───────────────────────────────────┘  │
├─────────────────────────────────────────┤
│   外部サービス                           │
│   - Replicate API（qwen3-tts）           │
│   - ffmpeg（ローカルプロセス）             │
└─────────────────────────────────────────┘
```

#### フロントエンド（Vue.js）
- **責務**: UI表示、ユーザー入力、マイク録音、音声再生、進捗表示
- **許可される操作**: バックエンドAPIの呼び出し
- **禁止される操作**: Replicate APIへの直接アクセス、ファイルシステムアクセス

#### コントローラー層
- **責務**: HTTPリクエスト受付、入力バリデーション、レスポンス整形
- **許可される操作**: サービス層の呼び出し
- **禁止される操作**: データ層への直接アクセス

#### サービス層
- **責務**: TTS生成、BGM合成、ジョブ管理のビジネスロジック
- **許可される操作**: データ層・外部サービスの呼び出し
- **禁止される操作**: HTTPリクエスト/レスポンスへの依存

#### データ層
- **責務**: メタデータと音声ファイルの永続化・取得
- **許可される操作**: ファイルシステムへの読み書き
- **禁止される操作**: ビジネスロジックの実装

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| 声のメタデータ | JSONファイル | voices.json | 個人利用で少量データ。DBは過剰 |
| 声の音声ファイル | ファイルシステム | webm/wav | バイナリデータはファイル保存が自然 |
| BGMファイル | ファイルシステム | mp3等 | 同上 |
| 生成済みポッドキャスト | ファイルシステム | mp3 | 同上 |
| ジョブ状態 | インメモリ | - | 一時的な状態。サーバー再起動で消えてよい |

### ディレクトリ構造

```
data/
├── voices/
│   ├── voices.json        # メタデータ
│   └── {uuid}.webm        # 音声ファイル
├── bgm/
│   └── {uuid}.mp3         # BGMファイル
├── temp/
│   └── {job-uuid}-tts.wav # TTS一時ファイル
└── output/
    └── {job-uuid}.mp3     # 完成品
```

### バックアップ戦略

- **対象**: `data/voices/` ディレクトリ（声のメタデータと音声ファイル）
- **方式**: ユーザーが手動でコピー（個人利用のため自動バックアップは不要）
- **復元方法**: `data/voices/` ディレクトリを復元する

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 |
|------|---------|---------|
| 声の一覧取得 | 100ms以内 | ローカル環境 |
| 声の録音開始 | 1秒以内 | ブラウザのマイクAPI許可済み |
| 声の保存（アップロード） | 2秒以内 | 50MB以下の音声ファイル |
| TTS音声生成 | Replicate API依存 | UIで進捗表示 |
| BGM合成（ffmpeg） | 10秒以内 | 5分の音声、ローカル環境 |
| mp3ダウンロード | 1秒以内 | ローカル環境 |

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ（サーバー） | 512MB | 音声ファイル処理時の一時バッファ |
| ディスク（data/） | 1GB | 声10件 + 出力ファイル数十件を想定 |

## セキュリティアーキテクチャ

### データ保護

- **APIキー管理**: Replicate APIキーは `.env` ファイルに格納し、サーバーサイドでのみ使用
- **`.env`のバージョン管理除外**: `.gitignore` に `.env` を含める
- **ファイル名**: ユーザー入力を直接ファイル名に使用せず、UUIDで管理（パストラバーサル防止）

### 入力検証

- **ラベル**: 1-100文字、HTMLタグのサニタイズ
- **台本テキスト**: 1文字以上（上限はReplicate APIの制限に準じる）
- **BGM音量**: 0.0-1.0の数値
- **ファイルサイズ**: 声 50MB以下、BGM 100MB以下

### ネットワーク

- **ローカル専用**: サーバーは `localhost` にのみバインド
- **外部通信**: Replicate APIへのHTTPS通信のみ

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**: 声10件程度、生成済みポッドキャスト数十件
- **対策不要**: 個人利用でデータ量が限定的なため、大規模対応は不要
- **一時ファイルのクリーンアップ**: `data/temp/` はジョブ完了後に自動削除

### 機能拡張性

- **コントローラー/サービスの分離**: 新しいAPIエンドポイントの追加が容易
- **サービス層の独立性**: TTSプロバイダーの変更（例: qwen3-tts → 別のTTS）がサービス層の差し替えで対応可能
- **Vueコンポーネントの分離**: 新しいUI機能の追加が既存コンポーネントに影響しにくい設計

## テスト戦略

### ユニットテスト（Vitest）
- **対象**: サービス層（TTSService, AudioMixer）、データ層（VoiceRepository）、入力バリデーション
- **カバレッジ目標**: サービス層80%以上
- **モック**: Replicate API、ffmpegプロセスをモック

### E2Eテスト（Playwright）
- **シナリオ1**: 声の登録 → 一覧表示 → 試聴 → 削除
- **シナリオ2**: 台本入力 → 声選択 → ポッドキャスト生成 → ダウンロード
- **モック**: Replicate APIをモックサーバーで代替

## 技術的制約

### 環境要件
- **OS**: Windows / macOS / Linux
- **Node.js**: v24.13.0以上
- **ffmpeg**: システムにインストール済みであること
- **ブラウザ**: Chrome/Edge（マイクAPI対応が必要）

### パフォーマンス制約
- TTS生成速度はReplicate APIのレスポンスタイムに依存
- 長い台本はAPI側の制限により分割が必要になる可能性がある

### セキュリティ制約
- Replicate APIキーが必要（ユーザーが自身のアカウントで取得）
- ローカルネットワーク上での利用を前提とし、インターネット公開は想定しない

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| vue | フロントエンドフレームワーク | ^3（マイナーバージョンまで自動） |
| vite | ビルドツール | ^6（マイナーバージョンまで自動） |
| hono | バックエンドサーバー | ^4（マイナーバージョンまで自動） |
| @hono/node-server | Node.jsアダプター | latest |
| replicate | Replicate API SDK | ^1（マイナーバージョンまで自動） |
| fluent-ffmpeg | ffmpegラッパー | ^2（マイナーバージョンまで自動） |
| uuid | UUID生成 | ^11（マイナーバージョンまで自動） |
| vitest | ユニットテスト | ^3（dev dependency） |
| playwright | E2Eテスト | ^1（dev dependency） |
